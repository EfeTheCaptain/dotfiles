#!/bin/bash

# Get search query
read -rp "🔍 Search YouTube: " query
[ -z "$query" ] && exit 1

# Get 5 results with proper error handling
results=$(yt-dlp --flat-playlist --default-search "ytsearch5" -j "$query" 2>/dev/null)
[ -z "$results" ] && echo "Error: No results found or connection failed" && exit 1

# Format results with duration or fallback
formatted_results=$(echo "$results" | jq -sr '.[] | 
  if .duration? then 
    "[\(.duration|tonumber|strftime("%M:%S"))] \(.title)"
  else 
    "[?:??] \(.title)" 
  end')

# Select with fzf
selected=$(echo "$formatted_results" | fzf --height=40% --reverse --cycle --prompt="Select song: ")
[ -z "$selected" ] && exit 0

# Extract title (handles cases where duration is missing)
title="${selected#*] }"

# Get URL with exact match
url=$(echo "$results" | jq -r --arg t "$title" '.[] | select(.title == $t) | .webpage_url')

# Play with error checking
if [ -n "$url" ]; then
    mpv --no-video --vo=null --ao=alsa \
        --demuxer-max-bytes=20MiB \
        --demuxer-max-back-bytes=4MiB \
        "$url" || echo "Playback failed"
else
    echo "Error: Could not extract URL for selected video"
    exit 1
fi
