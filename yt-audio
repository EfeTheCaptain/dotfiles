#!/bin/bash

# Get search query
read -rp "🔍 Search YouTube: " query
[ -z "$query" ] && exit 1

# Get 5 results as JSON array
results=$(yt-dlp --flat-playlist --default-search "ytsearch5" -j "$query" 2>/dev/null | jq -s '.')
if [ -z "$results" ] || [ "$results" = "[]" ]; then
    echo "Error: No results found or connection failed"
    exit 1
fi

# Format results for display
formatted_results=$(echo "$results" | jq -r '.[] | 
  ((.duration? // 0) | tonumber | strftime("%M:%S")) as $dur |
  "[\($dur)] \(.title)"')

# Select with fzf
selected=$(echo "$formatted_results" | fzf --height=40% --reverse --cycle --prompt="Select song: ")
[ -z "$selected" ] && exit 0

# Extract clean title (handles special characters and trims spaces)
title=$(echo "$selected" | sed 's/^\[[^]]*\] //' | sed 's/[[:space:]]*$//')

# Get URL by matching exact title from original results
url=$(echo "$results" | jq -r --arg t "$title" '
  .[] | 
  select(.title == $t) | 
  .webpage_url')

# Play with error checking
if [ -n "$url" ]; then
    echo "Playing: $title"
    mpv --no-video \
        --vo=null \
        --ao=alsa \
        --demuxer-max-bytes=20MiB \
        --demuxer-max-back-bytes=4MiB \
        --no-ytdl \
        --stream-lavf-o=protocol_whitelist=file,http,https,tcp,tls \
        "$url" || {
            echo "Playback failed"
            exit 1
        }
else
    echo "Error: Could not extract URL for selected video"
    exit 1
fi
