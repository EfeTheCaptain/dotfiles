#!/bin/bash

# Get search query
read -rp "üîç Search YouTube: " query
[ -z "$query" ] && exit

# Search and select with fzf
selected=$(yt-dlp --flat-playlist --default-search "ytsearch" -j "$query" | \
  jq -r '"[\(.duration|strftime("%M:%S"))] \(.title)"' | \
  fzf --height=40% --reverse --cycle --prompt="Select song: ")

# Exit if no selection
[ -z "$selected" ] && exit

# Extract and play URL
url=$(yt-dlp --flat-playlist --default-search "ytsearch" -j "$query" | \
  jq -r --arg title "${selected#*] }" 'select(.title == $title) | .webpage_url')

[ -n "$url" ] && mpv --no-video --vo=null --ao=alsa \
  --demuxer-max-bytes=20MiB \
  --demuxer-max-back-bytes=4MiB \
  "$url"
